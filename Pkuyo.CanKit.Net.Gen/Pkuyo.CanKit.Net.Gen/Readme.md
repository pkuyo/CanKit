# Pkuyo.CanKit.Net.Gen — CAN Options Source Generator

A Roslyn Incremental Source Generator that reduces boilerplate for CAN device/channel option types. It auto-implements partial properties marked with attributes and generates a unified `Apply` method to push changes to a runtime applier.

This repository contains:
- Pkuyo.CanKit.Net.Gen — the source generator (netstandard2.0)
- Pkuyo.CanKit.Net.Gen.Sample — a sample project referencing the generator as an analyzer
- Pkuyo.CanKit.Net.Gen.Tests — unit tests (optional)

## How it works
1) Decorate your options container**** type with `CanOptionAttribute`.
2) For each option, declare a partial auto-property and annotate it with `CanOptionItemAttribute(name, optionType, defaultValue?)`.
3) Build the solution. The generator emits backing fields, property bodies (get/set or get/init), change tracking, and an `Apply(ICanApplier applier, bool force)` method.

Generated Apply logic only pushes values whose bit is marked changed (or when `force == true`) and whose `CanOptionType` matches the applier phase.

## Minimal example
```csharp
using Pkuyo.CanKit.Net.Core.Attributes;
using Pkuyo.CanKit.Net.Core.Definitions;

[CanOption]
public partial class MyChannelOptions
{
    [CanOptionItem("baud", CanOptionType.Init, "500_000")]
    public partial uint BaudRate { get; set; }

    [CanOptionItem("workMode", CanOptionType.Init)]
    public partial ChannelWorkMode WorkMode { get; set; }
}

// The generator produces:
// - backing fields, get/set bodies
// - a BitArray to track changes
// - public partial void Apply(ICanApplier applier, bool force)
```

## Adding the generator to your project
Reference the generator project as an Analyzer (not as a normal reference):
```xml
<ProjectReference Include="..\Pkuyo.CanKit.Net.Gen\Pkuyo.CanKit.Net.Gen.csproj"
                  OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
```
See sample: `Pkuyo.CanKit.Net.Gen.Sample/Pkuyo.CanKit.Net.Gen.Sample.csproj`.

## Diagnostics
- CANOPTGEN001 (Error): Property must be a partial auto-property with both accessors (get/set or get/init).
- CANOPTGEN002 (Error): Invalid accessibility when modifiers are present.

Release tracking files: see `AnalyzerReleases.Shipped.md` and `AnalyzerReleases.Unshipped.md`.

## Tips
- Use partial properties only; bodies are generated by the source generator.
- Provide a sensible default value in the attribute when needed.
- `force == true` in `Apply` ensures values are re-applied regardless of change bit.

## Learn more
- Roslyn Source Generators: https://github.com/dotnet/roslyn/blob/main/docs/features/source-generators.cookbook.md

For Chinese docs, see `Readme.zh-CN.md`.
